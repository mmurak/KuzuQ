<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kuzushi-ji Tester</title>
<link rel="stylesheet" href="praise.css">
<script src="praise.js"></script>

<script type="text/javascript" src="master002B.js"></script>

<script type="text/javascript">
<!--
// Global section
const header = "./imagePool/";
const suffix = ".jpg";
const pattern = /\/([^ (]+)/;
var currentMode = 0;    // 0=start, 1=check, 2=next
var numOfR = 0;
var qNo = 0;
var numOfQ;
var imageList = [];


// 'Shuffler' from https://bost.ocks.org/mike/shuffle/
function shuffle(array) {
  var m = array.length, t, i;

  // While there remain elements to shuffle…
  while (m) {
    // Pick a remaining element…
    i = Math.floor(Math.random() * m--);
    // And swap it with the current element.
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
  return array;
}



// Image retrieving methods
nextImagePtr = 0;     // as static variable
function nextList() {
  if (nextImagePtr == imageList.length) {
    return "";
  }
  return header + imageList[nextImagePtr++] + suffix;
}

function nextImage() {
  var panel = document.getElementById("imageArea");
  var cache = document.getElementById("preloadArea");
  if (nextImagePtr == 0) { // 初回？
    panel.src = nextList();
    cache.src = nextList();
  } else {
    panel.src=cache.src;
    var temp = nextList();
    if (temp != "") {       // No assignment when the list is empty.
      cache.src = temp;
    }
  }
}

function _keepingTidy() {
  var button = document.getElementById("multiButton");
  var inField = document.getElementById("ansField");
  var descField = document.getElementById("expField");
  qNo += 1;
  currentMode = 1;    // Set mode to 'entry.'
  button.value = "チェック";
  inField.value = "";
  inField.focus();
  descField.firstChild.nodeValue = getScore();
  nextImage();
}

function clicked() {
  var button = document.getElementById("multiButton");
  var inField = document.getElementById("ansField");
  var descField = document.getElementById("expField");
  if (currentMode == 0) {   // start/next
    _keepingTidy();
  } else if (currentMode == 1) {  // check
    var sourceName = imageList[qNo - 1];
    var answer = sourceName.charAt(0);
    var title = sourceName.match(pattern)[1];
    var input = inField.value;
    input = input.trim().charAt(0);
    inField.value = input;    // in case of multiple character input
    if (input == answer) {
      numOfR += 1;
      descField.firstChild.nodeValue = getScore() + " " +answer + "で正解！（" + title + "）";
    } else {
      descField.firstChild.nodeValue = getScore() + " 残念！答えは" + answer + "です（" + title + "）";
    }
    currentMode = 2;
    button.value = "次へ";
  } else if (currentMode == 2) {  // next
      if (numOfQ < qNo) {
          if (numOfR == (numOfQ + 1)) {
            petalStart();
            descField.firstChild.nodeValue = getScore() + " 全問正解！！！　お疲れさまでした！";
          } else {
            descField.firstChild.nodeValue = getScore() + " お疲れさまでした！";
          }
          currentMode = 3;
          button.value = "もう一度やる";
      } else {
        _keepingTidy();
      }
  } else if (currentMode == 3) {  // retry
    window.location.reload();
  }
}


function checkEnter(e) {
  if (e.keyCode == 13) {
    clicked();
  }
}

function getScore() {
  return numOfR + "/" + qNo + "/" + (numOfQ + 1);
}

// Entry point
function initialize() {
  for (var i = 0; i < mastData.length; i++) {
    var idx = Math.floor(Math.random() * mastData[i].length)
    imageList.push(mastData[i][idx]);
    numOfQ = i;
  }
  qNo = 0;
  var ans = document.getElementById("ansField");
  ans.addEventListener("keypress", checkEnter);
  imageList = shuffle(imageList);
  document.getElementById("ansField").focus();
}


// -->
</script>

</head>
<body onLoad="initialize();" style="background-color: #F8F0F0">
<div class="cherry-blossom-container">

<h4>小学校2年生編（Part.2--50種）</h4>
<input type="button" id="multiButton" value="スタート" onclick="clicked();">
<input type="text" id="ansField" size="5" style="font-size: 26px;">
<div id="expField">　</div>
<hr>
<img id="preloadArea" src="" width="1px" height="1px"></img>
<img id="imageArea" width="100" src=""></img>


<br/>
<span style="font-size: 6px">データは『日本古典籍くずし字データセット』（国文研ほか所蔵／CODH加工） doi:10.20676/00000340 のものを使用しています。<br/>
提供：<a href="http://codh.rois.ac.jp/">人文学オープンデータ共同利用センター</a></span>

</div>
</body>
</html>
